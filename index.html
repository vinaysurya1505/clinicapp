<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Admin Panel</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #3b82f6; color: white; }
        .modal-bg { background-color: rgba(0,0,0,0.5); z-index: 50; }
        .modal-content { max-height: 90vh; }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media print {
            body * { visibility: hidden; }
            #pdf-preview, #pdf-preview * { visibility: visible; }
            #pdf-preview { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container">
        </div>
    <!-- Success Modal for Bill Creation -->
    <div id="success-modal" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900">Bill Created Successfully!</h3>
            <p id="success-modal-bill-number" class="text-sm text-gray-500 mt-2"></p>
            <div class="mt-5 flex justify-center gap-3">
                <button type="button" id="success-modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
                <button type="button" id="success-modal-print" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200">Print</button>
                <button type="button" id="success-modal-download" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Download PDF</button>
            </div>
        </div>
    </div>

    <div id="pdf-preview" class="hidden fixed -left-[2000px] top-0 w-[800px] bg-white text-black p-8 font-sans">
        </div>

    <script>
    // ========================================================================
    // --- 1. FIREBASE & APP INITIALIZATION ---
    // ========================================================================
    document.addEventListener('DOMContentLoaded', () => {

        // --- PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCgS6lirvE-U80iTQepuutMoBkmL7ulXWQ",
            authDomain: "pathology-lab-app.firebaseapp.com",
            projectId: "pathology-lab-app",
            storageBucket: "pathology-lab-app.appspot.com",
            messagingSenderId: "211522598277",
            appId: "1:211522598277:web:db034868d194718c0a40ec",
            measurementId: "G-2V8NCW7NZH"
        };
        // ----------------------------------------------------

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { Timestamp, FieldValue } = firebase.firestore;

        const appContainer = document.getElementById('app-container');

        // Global state object
        const state = {
            user: null,
            currentPage: 'home',
            listeners: [], // To store unsubscribe functions for Firestore
        };

        // ========================================================================
        // --- 2. AUTHENTICATION LOGIC ---
        // ========================================================================
        auth.onAuthStateChanged(user => {
            // Unsubscribe from all previous Firestore listeners
            state.listeners.forEach(unsubscribe => unsubscribe());
            state.listeners = [];
            
            if (user) {
                state.user = user;
                if(state.currentPage === 'login' || state.currentPage === 'home') {
                    state.currentPage = 'dashboard';
                }
            } else {
                state.user = null;
                state.currentPage = 'home';
            }
            renderApp();
        });

        function handleLogin(email, password) {
            const errorEl = document.getElementById('login-error');
            const button = document.querySelector('#login-form button[type="submit"]');
            errorEl.textContent = '';
            button.disabled = true;
            button.textContent = 'Signing In...';
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    errorEl.textContent = error.message || "Failed to login. Please check your credentials.";
                    button.disabled = false;
                    button.textContent = 'Sign In';
                });
        }

        function handleLogout() {
            auth.signOut();
        }
        
        // ========================================================================
        // --- 3. UI RENDERING & ROUTING ---
        // ========================================================================
        function renderApp() {
            const page = state.currentPage;
            if (!state.user && page !== 'home' && page !== 'login') {
                renderHomePage();
                return;
            }

            switch (page) {
                case 'home': renderHomePage(); break;
                case 'login': renderLoginPage(); break;
                case 'dashboard': renderAdminLayout('Dashboard', renderDashboard); break;
                case 'billing': renderAdminLayout('Billing', initializeBillingPage); break;
                case 'tests': renderAdminLayout('Manage Tests', initializeTestsPage); break;
                case 'doctors': renderAdminLayout('Manage Doctors', initializeDoctorsPage); break;
                case 'expenditures': renderAdminLayout('Expenditures', initializeExpendituresPage); break;
                case 'reports': renderAdminLayout('Financial Reports', renderReportsPage); break;
                default: renderHomePage();
            }
        }
        
        function navigate(page) {
            state.currentPage = page;
            renderApp();
        }

        // ========================================================================
        // --- 4. HTML TEMPLATES & COMPONENTS ---
        // ========================================================================
        
        // --- PUBLIC PAGES ---
        function renderHomePage() {
            appContainer.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-md">
                        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-gray-800">Perfect Diagnostic and Ultrasound Centre</h1>
                            <button id="go-to-login-nav" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                                Admin Login
                            </button>
                        </nav>
                    </header>
                    <main>
                        <section class="bg-blue-600 text-white">
                            <div class="container mx-auto px-6 py-20 text-center">
                                <h2 class="text-4xl font-extrabold leading-tight md:text-5xl">Your Partner in Accurate Diagnostics</h2>
                                <p class="mt-4 text-lg text-blue-100">State-of-the-art technology ensuring patient care and satisfaction.</p>
                            </div>
                        </section>
                        <section class="py-16 bg-white">
                            <div class="container mx-auto px-6 text-center">
                                <h3 class="text-3xl font-bold text-gray-800 mb-8">Contact Us</h3>
                                <div class="flex flex-wrap justify-center gap-8 md:gap-12">
                                    <div class="flex items-start max-w-sm">
                                        <div class="flex-shrink-0">
                                            <div class="flex items-center justify-center h-12 w-12 rounded-md bg-blue-100 text-blue-600">
                                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            </div>
                                        </div>
                                        <div class="ml-4 text-left">
                                            <h4 class="text-lg leading-6 font-medium text-gray-900">Address</h4>
                                            <p class="mt-2 text-base text-gray-500">Near Government Hospital, Front of Old Gate, Partawal Bazar, Maharajganj, Uttar Pradesh</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start max-w-sm">
                                        <div class="flex-shrink-0">
                                            <div class="flex items-center justify-center h-12 w-12 rounded-md bg-blue-100 text-blue-600">
                                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                            </div>
                                        </div>
                                        <div class="ml-4 text-left">
                                            <h4 class="text-lg leading-6 font-medium text-gray-900">Phone & Email</h4>
                                            <p class="mt-2 text-base text-gray-500">
                                                +91 9838104111<br>+91 9616434212<br>perfectdiagnostic@gmail.com
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </main>
                    <footer class="bg-gray-800 text-white">
                        <div class="container mx-auto px-6 py-4 text-center">
                            <p>&copy; ${new Date().getFullYear()} Perfect Diagnostic and Ultrasound Centre. All Rights Reserved.</p>
                        </div>
                    </footer>
                </div>
            `;
            document.getElementById('go-to-login-nav').onclick = () => navigate('login');
        }

        function renderLoginPage() {
            appContainer.innerHTML = `
                <div class="min-h-screen bg-gray-100 flex items-center justify-center">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Admin Login</h2>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <p id="login-error" class="text-red-500 text-sm mb-4"></p>
                            <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors">Sign In</button>
                            <button id="back-to-home" type="button" class="mt-4 w-full text-center text-sm text-gray-600 hover:text-blue-600">Back to Home</button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('login-form').onsubmit = (e) => {
                e.preventDefault();
                handleLogin(e.target.email.value, e.target.password.value);
            };
            document.getElementById('back-to-home').onclick = () => navigate('home');
        }

        // --- ADMIN LAYOUT ---
        function renderAdminLayout(title, contentRenderer) {
            appContainer.innerHTML = `
                <div class="flex h-screen bg-gray-200">
                    <aside class="w-64 bg-gray-800 text-white flex flex-col">
                        <div class="h-16 flex items-center justify-center text-2xl font-bold">ClinicPro</div>
                        <nav class="flex-1 px-2 py-4 space-y-2">
                            ${SidebarItem('dashboard', 'Dashboard')}
                            ${SidebarItem('billing', 'Billing')}
                            ${SidebarItem('tests', 'Tests')}
                            ${SidebarItem('doctors', 'Doctors')}
                            ${SidebarItem('expenditures', 'Expenditure')}
                            ${SidebarItem('reports', 'Financial Report')}
                        </nav>
                        <div class="p-4">
                            <button id="logout-btn" class="w-full py-2 px-4 text-left rounded-md sidebar-link">Sign Out</button>
                        </div>
                    </aside>
                    <main class="flex-1 flex flex-col overflow-hidden">
                        <header class="h-16 bg-white border-b border-gray-200 flex items-center px-6">
                            <h1 class="text-2xl font-semibold text-gray-800">${title}</h1>
                        </header>
                        <div id="page-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6">
                           </div>
                    </main>
                </div>
            `;
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    navigate(e.currentTarget.dataset.page);
                };
            });
            document.getElementById('logout-btn').onclick = handleLogout;
            
            contentRenderer();
        }
        
        function SidebarItem(page, text) {
            const isActive = state.currentPage === page ? 'active' : '';
            return `<a href="#" data-page="${page}" class="nav-link block py-2 px-4 rounded-md sidebar-link ${isActive}">${text}</a>`;
        }

        // ========================================================================
        // --- 5. GENERIC CRUD PAGE LOGIC ---
        // ========================================================================

        function createCrudPage(collectionName, title, formFields, tableHeaders, renderRow) {
            const content = document.getElementById('page-content');
            let editingId = null;

            // Generate form HTML from formFields config
            const formInputs = formFields.map(f => `
                <div class="mb-4">
                    <label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}</label>
                    <input type="${f.type}" id="${f.id}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
            `).join('');

            // Generate table header HTML
            const tableHeaderRow = tableHeaders.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('');

            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 id="form-title" class="text-lg font-medium leading-6 text-gray-900 mb-4">Add New ${title}</h3>
                            <form id="crud-form">
                                ${formInputs}
                                <div class="flex items-center gap-4">
                                    <button type="submit" id="submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save ${title}</button>
                                    <button type="button" id="cancel-btn" class="px-4 py-2 text-gray-600 hover:text-gray-900 hidden">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>${tableHeaderRow}</tr>
                                </thead>
                                <tbody id="crud-table-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            const form = document.getElementById('crud-form');
            const tableBody = document.getElementById('crud-table-body');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');

            function resetForm() {
                form.reset();
                editingId = null;
                formTitle.textContent = `Add New ${title}`;
                submitBtn.textContent = `Save ${title}`;
                cancelBtn.classList.add('hidden');
            }

            cancelBtn.onclick = resetForm;
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                const data = {};
                formFields.forEach(f => {
                    const input = document.getElementById(f.id);
                    data[f.key] = f.type === 'number' ? parseFloat(input.value) : input.value;
                });

                try {
                    if (editingId) {
                        await db.collection(collectionName).doc(editingId).update(data);
                    } else {
                        // Add default values for new entries if any
                        if (collectionName === 'doctors') {
                            data.commissionBalance = 0;
                        }
                        if (collectionName === 'expenditures') {
                            data.date = Timestamp.now();
                        }
                        await db.collection(collectionName).add(data);
                    }
                    resetForm();
                } catch (error) {
                    console.error("Error saving document: ", error);
                    alert("Failed to save. Check console for details.");
                }
            };

            const unsubscribe = db.collection(collectionName).onSnapshot(snapshot => {
                tableBody.innerHTML = '';
                if (snapshot.empty) {
                    tableBody.innerHTML = `<tr><td colspan="${tableHeaders.length}" class="text-center py-4">No ${title}s found.</td></tr>`;
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const docData = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = renderRow(doc.id, docData);
                    
                    row.querySelector('.edit-btn').onclick = () => {
                        editingId = doc.id;
                        formFields.forEach(f => {
                            document.getElementById(f.id).value = docData[f.key];
                        });
                        formTitle.textContent = `Edit ${title}`;
                        submitBtn.textContent = `Update ${title}`;
                        cancelBtn.classList.remove('hidden');
                        window.scrollTo(0, 0);
                    };

                    row.querySelector('.delete-btn').onclick = async () => {
                        if (confirm(`Are you sure you want to delete this ${title}?`)) {
                            await db.collection(collectionName).doc(doc.id).delete();
                        }
                    };

                    tableBody.appendChild(row);
                });
            });
            state.listeners.push(unsubscribe); // Store unsubscribe function
        }

        function initializeTestsPage() {
            createCrudPage(
                'tests',
                'Test',
                [
                    { id: 'test-name', label: 'Test Name', type: 'text', key: 'name' },
                    { id: 'test-price', label: 'Price (₹)', type: 'number', key: 'price' }
                ],
                ['Name', 'Price', 'Actions'],
                (id, data) => `
                    <td class="px-6 py-4 whitespace-nowrap">${data.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${data.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-900 ml-4">Delete</button>
                    </td>
                `
            );
        }

        function initializeDoctorsPage() {
             createCrudPage(
                'doctors',
                'Doctor',
                [
                    { id: 'doctor-name', label: 'Doctor Name', type: 'text', key: 'name' },
                    { id: 'doctor-commission', label: 'Commission (%)', type: 'number', key: 'commissionPercent' }
                ],
                ['Name', 'Commission %', 'Commission Balance', 'Actions'],
                (id, data) => `
                    <td class="px-6 py-4 whitespace-nowrap">${data.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.commissionPercent || 0}%</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${(data.commissionBalance || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-900 ml-4">Delete</button>
                    </td>
                `
            );
        }

        function initializeExpendituresPage() {
             createCrudPage(
                'expenditures',
                'Expenditure',
                [
                    { id: 'exp-description', label: 'Description', type: 'text', key: 'description' },
                    { id: 'exp-amount', label: 'Amount (₹)', type: 'number', key: 'amount' }
                ],
                ['Description', 'Amount', 'Date', 'Actions'],
                (id, data) => `
                    <td class="px-6 py-4 whitespace-nowrap">${data.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${data.amount.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${data.date.toDate().toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button class="delete-btn text-red-600 hover:text-red-900 ml-4">Delete</button>
                    </td>
                `
            );
        }
        
        // ========================================================================
        // --- 6. BILLING PAGE LOGIC ---
        // ========================================================================
        async function initializeBillingPage() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Recent Bills</h2>
                    <button id="add-bill-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create New Bill</button>
                </div>
                <div class="bg-white shadow rounded-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left">Bill #</th>
                                <th class="px-6 py-3 text-left">Patient</th>
                                <th class="px-6 py-3 text-left">Date</th>
                                <th class="px-6 py-3 text-left">Total</th>
                                <th class="px-6 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bills-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                
                <div id="bill-modal" class="fixed inset-0 modal-bg hidden flex items-center justify-center p-4">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl modal-content overflow-y-auto">
                        <h3 id="modal-title" class="text-2xl mb-4 font-bold">Create Bill</h3>
                        <form id="bill-form">
                            <fieldset class="border p-4 rounded-md mb-4">
                                <legend class="px-2 font-semibold">Patient Details</legend>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm">Patient Name*</label><input type="text" id="patient-name" class="w-full p-2 border rounded-md" required></div>
                                    <div><label class="block text-sm">Phone</label><input type="tel" id="patient-phone" class="w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm">Age</label><input type="number" id="patient-age" class="w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm">Gender</label><select id="patient-gender" class="w-full p-2 border rounded-md"><option>Male</option><option>Female</option><option>Other</option></select></div>
                                    <div class="md:col-span-2"><label class="block text-sm">Referred By</label><select id="referred-by" class="w-full p-2 border rounded-md"><option value="">None</option></select></div>
                                </div>
                            </fieldset>
                            
                            <fieldset class="border p-4 rounded-md mb-4">
                                <legend class="px-2 font-semibold">Bill Items</legend>
                                <div id="bill-items" class="space-y-3 mb-3"></div>
                                <button type="button" id="add-item-btn" class="px-3 py-1 bg-green-500 text-white text-sm rounded-md hover:bg-green-600">Add Test</button>
                            </fieldset>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4">
                                <div class="space-y-2">
                                    <div><label class="block text-sm">Discount (%)</label><input type="number" id="discount-percent" value="0" min="0" max="100" class="w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm">GST (%)</label><input type="number" id="gst-percent" value="0" min="0" class="w-full p-2 border rounded-md"></div>
                                </div>
                                <div class="text-right space-y-1 text-gray-700">
                                    <p>Subtotal: <span id="subtotal" class="font-medium text-black">₹0.00</span></p>
                                    <p>Discount: <span id="discount-amount" class="font-medium text-black">₹0.00</span></p>
                                    <p class="border-t pt-1 mt-1">Total after Discount: <span id="post-discount-total" class="font-medium text-black">₹0.00</span></p>
                                    <p>GST: <span id="gst-amount" class="font-medium text-black">₹0.00</span></p>
                                    <p class="font-bold text-xl border-t pt-1 mt-1">Grand Total: <span id="grand-total" class="text-blue-600">₹0.00</span></p>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-4 mt-6">
                                <button type="button" id="close-modal-btn" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Bill</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // --- State for billing form ---
            let allTests = [];
            let allDoctors = [];

            const billModal = document.getElementById('bill-modal');
            const billForm = document.getElementById('bill-form');
            const billItemsContainer = document.getElementById('bill-items');

            // --- Load initial data for dropdowns ---
            async function loadPrerequisites() {
                const testsSnapshot = await db.collection('tests').get();
                allTests = testsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const doctorsSnapshot = await db.collection('doctors').get();
                allDoctors = doctorsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const referredBySelect = document.getElementById('referred-by');
                referredBySelect.innerHTML = '<option value="">None</option>' + allDoctors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            }

            // --- Event Listeners for the page ---
            document.getElementById('add-bill-btn').onclick = () => {
                loadPrerequisites().then(() => {
                    addBillItem();
                    openModal();
                });
            };
            document.getElementById('close-modal-btn').onclick = closeModal;
            document.getElementById('add-item-btn').onclick = addBillItem;

            // Add listeners for total calculation
            ['discount-percent', 'gst-percent'].forEach(id => {
                const el = document.getElementById(id);
                el.onchange = updateBillTotals;
                el.onkeyup = updateBillTotals;
            });

            // --- Handle Form Submission ---
            billForm.onsubmit = async (e) => {
                e.preventDefault();
                const submitBtn = billForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                try {
                    // 1. Get or create patient
                    const patientPhone = document.getElementById('patient-phone').value.trim();
                    let patientId;

                    const patientDetails = {
                        name: document.getElementById('patient-name').value,
                        age: parseInt(document.getElementById('patient-age').value) || null,
                        gender: document.getElementById('patient-gender').value,
                        phone: patientPhone || null 
                    };

                    let patientQuery;
                    if (patientPhone) {
                        patientQuery = await db.collection('patients').where('phone', '==', patientPhone).limit(1).get();
                    }

                    if (patientPhone && patientQuery && !patientQuery.empty) {
                        patientId = patientQuery.docs[0].id;
                        await db.collection('patients').doc(patientId).update(patientDetails);
                    } else {
                        const newPatientRef = await db.collection('patients').add(patientDetails);
                        patientId = newPatientRef.id;
                    }
                    // 2. Prepare bill items
                    const items = [];
                    billItemsContainer.querySelectorAll('.bill-item').forEach(itemRow => {
                        const testId = itemRow.querySelector('.item-test-select').value;
                        const selectedTest = allTests.find(t => t.id === testId);
                        if(selectedTest) {
                             items.push({
                                testId: testId,
                                name: selectedTest.name,
                                price: selectedTest.price,
                                quantity: parseInt(itemRow.querySelector('.item-quantity').value) || 1
                            });
                        }
                    });

                    if (items.length === 0) throw new Error("At least one test must be added to the bill.");

                    // 3. Get totals
                    const subtotal = items.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                    const discountPercent = parseFloat(document.getElementById('discount-percent').value) || 0;
                    const gstPercent = parseFloat(document.getElementById('gst-percent').value) || 0;
                    const total = subtotal - (subtotal * (discountPercent / 100)) + ((subtotal - (subtotal * (discountPercent/100))) * (gstPercent / 100));

                    // 4. Generate Bill Number
                    const counterRef = db.collection('metadata').doc('counters');
                    const newBillNumber = await db.runTransaction(async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        if (!counterDoc.exists) throw "Bill counter document not found!";
                        const newBillNo = counterDoc.data().billNo;
                        transaction.update(counterRef, { billNo: FieldValue.increment(1) });
                        return `PDB${newBillNo}`;
                    });

                    // 5. Save Bill
                    const billData = {
                        patientId, patientDetails, billNumber: newBillNumber,
                        referredById: document.getElementById('referred-by').value || null,
                        items, subtotal, discountPercent, gstPercent, total,
                        createdAt: Timestamp.now()
                    };

                    const billRef = await db.collection('bills').add(billData);

                    // 6. Create income transaction
                    await db.collection('transactions').add({
                        type: 'income', amount: total, description: `Payment for Bill #${newBillNumber}`,
                        relatedBillId: billRef.id, date: Timestamp.now()
                    });

                    // 7. Handle doctor commission
                    const referredById = document.getElementById('referred-by').value;
                    if (referredById) {
                        const doctor = allDoctors.find(d => d.id === referredById);
                        if (doctor && doctor.commissionPercent > 0) {
                            const commissionAmount = subtotal * (doctor.commissionPercent / 100);
                            await db.collection('doctors').doc(referredById).update({ commissionBalance: FieldValue.increment(commissionAmount) });
                            await db.collection('transactions').add({
                                type: 'commission', amount: commissionAmount, description: `Commission for Bill #${newBillNumber}`,
                                relatedBillId: billRef.id, relatedDoctorId: referredById, date: Timestamp.now()
                            });
                        }
                    }

                    // --- THIS IS THE NEW PART ---
                    // Show the new success modal instead of the old alert
                    closeModal();
                    showSuccessModal(billRef.id, newBillNumber);

                } catch (error) {
                    console.error("Error creating bill: ", error);
                    alert("Failed to create bill: " + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Bill';
                }
            };

            // --- NEW/UPDATED PDF and MODAL FUNCTIONS ---
            function showSuccessModal(billId, billNumber) {
                const modal = document.getElementById('success-modal');
                document.getElementById('success-modal-bill-number').textContent = `Bill No: ${billNumber}`;
                modal.classList.remove('hidden');

                document.getElementById('success-modal-close').onclick = () => modal.classList.add('hidden');
                document.getElementById('success-modal-download').onclick = () => generateBillAction(billId, 'download');
                document.getElementById('success-modal-print').onclick = () => generateBillAction(billId, 'print');
            }

            async function generateBillAction(billId, action) {
                const { jsPDF } = window.jspdf;
                const loader = document.createElement('div');
                loader.innerHTML = `<div class=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\"><div class=\"spinner h-12 w-12 rounded-full border-4 border-t-blue-500\"></div></div>`;
                document.body.appendChild(loader);

                try {
                    const billDoc = await db.collection('bills').doc(billId).get();
                    if (!billDoc.exists) throw new Error("Bill not found");
                    const bill = billDoc.data();
                    const previewEl = document.getElementById('pdf-preview');
                    const doctorSnap = bill.referredById ? await db.collection('doctors').doc(bill.referredById).get() : null;
                    const doctorName = doctorSnap && doctorSnap.exists ? doctorSnap.data().name : 'None';
                    const itemsHtml = bill.items.map((item, index) => `
                        <tr>
                            <td style=\"padding: 8px; border: 1px solid #ddd;\">${index + 1}</td>
                            <td style=\"padding: 8px; border: 1px solid #ddd;\">${item.name}</td>
                            <td style=\"padding: 8px; border: 1px solid #ddd; text-align: right;\">${item.quantity}</td>
                            <td style=\"padding: 8px; border: 1px solid #ddd; text-align: right;\">${item.price.toFixed(2)}</td>
                            <td style=\"padding: 8px; border: 1px solid #ddd; text-align: right;\">${(item.price * item.quantity).toFixed(2)}</td>
                        </tr>`).join('');
                    previewEl.innerHTML = `
                        <div style=\"width: 210mm; height: 297mm; padding: 20mm; box-sizing: border-box; font-family: Arial, sans-serif; font-size: 12px; color: #333;\">
                            <div style=\"text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;\">
                                <h1 style=\"font-size: 24px; font-weight: bold; margin: 0; color: #000;\">Perfect Diagnostic and Ultrasound Centre</h1>
                                <p style=\"margin: 5px 0;\">Near Government Hospital, Front of Old Gate, Partawal Bazar, Maharajganj, Uttar Pradesh</p>
                                <p style=\"margin: 5px 0;\">Phone: +91 9838104111, +91 9616434212 | Email: perfectdiagnostic@gmail.com</p>
                            </div>
                            <table style=\"width: 100%; margin-bottom: 20px;\">
                                <tr>
                                    <td style=\"width: 50%; vertical-align: top;\">
                                        <h2 style=\"font-size: 14px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;\">Patient Information</h2>
                                        <p><strong>Name:</strong> ${bill.patientDetails.name}</p>
                                        <p><strong>Age/Gender:</strong> ${bill.patientDetails.age || 'N/A'} / ${bill.patientDetails.gender}</p>
                                        <p><strong>Mobile:</strong> ${bill.patientDetails.phone || 'N/A'}</p>
                                    </td>
                                    <td style=\"width: 50%; vertical-align: top;\">
                                        <h2 style=\"font-size: 14px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;\">Bill Details</h2>
                                        <p><strong>Bill No:</strong> ${bill.billNumber}</p>
                                        <p><strong>Date:</strong> ${bill.createdAt.toDate().toLocaleDateString()}</p>
                                        <p><strong>Doctor Referred:</strong> Dr. ${doctorName}</p>
                                    </td>
                                </tr>
                            </table>
                            <table style=\"width: 100%; border-collapse: collapse; font-size: 12px;\">
                                <thead style=\"background-color: #f2f2f2;\">
                                    <tr>
                                        <th style=\"padding: 8px; border: 1px solid #ddd; text-align: left;\">S.No</th>
                                        <th style=\"padding: 8px; border: 1px solid #ddd; text-align: left;\">Test Name</th>
                                        <th style=\"padding: 8px; border: 1px solid #ddd; text-align: right;\">Qty</th>
                                        <th style=\"padding: 8px; border: 1px solid #ddd; text-align: right;\">Rate (INR)</th>
                                        <th style=\"padding: 8px; border: 1px solid #ddd; text-align: right;\">Amount (INR)</th>
                                    </tr>
                                </thead>
                                <tbody>${itemsHtml}</tbody>
                            </table>
                            <table style=\"width: 40%; margin-left: 60%; margin-top: 20px; border-collapse: collapse;\">
                                <tr>
                                    <td style=\"padding: 8px;\">Subtotal:</td>
                                    <td style=\"padding: 8px; text-align: right;\">${bill.subtotal.toFixed(2)}</td>
                                </tr>
                                 <tr>
                                    <td style=\"padding: 8px;\">Discount (${bill.discountPercent}%):</td>
                                    <td style=\"padding: 8px; text-align: right;\">-${(bill.subtotal * bill.discountPercent/100).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style=\"padding: 8px;\">GST (${bill.gstPercent}%):</td>
                                    <td style=\"padding: 8px; text-align: right;\">${((bill.subtotal - (bill.subtotal * bill.discountPercent/100)) * bill.gstPercent/100).toFixed(2)}</td>
                                </tr>
                                <tr style=\"font-weight: bold; background-color: #f2f2f2; font-size: 14px;\">
                                    <td style=\"padding: 10px; border-top: 2px solid #333;\">Total:</td>
                                    <td style=\"padding: 10px; border-top: 2px solid #333; text-align: right;\">${bill.total.toFixed(2)}</td>
                                </tr>
                            </table>
                            <div style=\"position: absolute; bottom: 40px; right: 80px; text-align: center;\">
                                <p style=\"border-top: 1px solid #333; padding-top: 5px;\">Authorized Signatory</p>
                            </div>
                        </div>
                    `;
                    if (action === 'print') {
                        const originalTitle = document.title;
                        document.title = bill.billNumber;
                        window.print();
                        document.title = originalTitle;
                    } else {
                        const canvas = await html2canvas(previewEl, { scale: 3 });
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = 210;
                        const pdfHeight = 297;
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`${bill.billNumber}.pdf`);
                    }
                } catch (error) {
                    console.error("PDF Action Error:", error);
                    alert("Failed to perform action: " + error.message);
                } finally {
                    document.body.removeChild(loader);
                }
            }

            // --- Listen for and display recent bills ---
            const billsListBody = document.getElementById('bills-list-body');
            const unsubscribe = db.collection('bills').orderBy('createdAt', 'desc').limit(20).onSnapshot(snapshot => {
                billsListBody.innerHTML = '';
                if (snapshot.empty) {
                    billsListBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No bills found.</td></tr>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const bill = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium">${bill.billNumber}</td>
                        <td class="px-6 py-4">${bill.patientDetails.name}</td>
                        <td class="px-6 py-4">${bill.createdAt.toDate().toLocaleDateString()}</td>
                        <td class="px-6 py-4 font-semibold">₹${bill.total.toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <button data-id="${doc.id}" class="view-pdf-btn text-blue-600 hover:underline">View/PDF</button>
                        </td>
                    `;
                    billsListBody.appendChild(row);
                });
                // Add event listeners to newly created buttons
                document.querySelectorAll('.view-pdf-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        // Show modal for selected bill
                        showSuccessModal(e.target.dataset.id, e.target.closest('tr').querySelector('td').textContent);
                    };
                });
            });
            state.listeners.push(unsubscribe); // Store unsubscribe function
            // --- End of initializeBillingPage ---
        
        // ========================================================================
        // --- 7. REPORTS PAGE LOGIC (Placeholder) ---
        // ========================================================================
        function renderReportsPage() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Financial Reports</h2>
                    <p>This section is under development. It will contain detailed financial summaries, profit/loss statements, and doctor commission reports.</p>
                </div>
            `;
        }

        // ========================================================================
        // --- 8. DASHBOARD DATA & CHARTS ---
        // ========================================================================
        
        async function renderDashboard() {
            const content = document.getElementById('page-content');
            content.innerHTML = `
                <div id="dashboard-loader" class="text-center">Loading dashboard data...</div>
                <div id="dashboard-content" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-gray-500">Total Patients</h3><p id="total-patients" class="text-3xl font-bold">0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-gray-500">Total Income</h3><p id="total-income" class="text-3xl font-bold text-green-600">₹0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-gray-500">Paid Commission</h3><p id="total-commission" class="text-3xl font-bold text-orange-500">₹0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow"><h3 class="text-gray-500">Total Expenditure</h3><p id="total-expenditure" class="text-3xl font-bold text-red-600">₹0</p></div>
                    </div>
                    </div>
            `;

            try {
                // Fetch patient count
                const patientsSnapshot = await db.collection('patients').get();
                document.getElementById('total-patients').textContent = patientsSnapshot.size;

                // Fetch transactions and calculate totals
                const transactionsSnapshot = await db.collection('transactions').get();
                let totalIncome = 0;
                let totalCommission = 0;
                let totalExpenditure = 0;

                transactionsSnapshot.forEach(doc => {
                    const t = doc.data();
                    if (t.type === 'income') totalIncome += t.amount;
                    if (t.type === 'commission') totalCommission += t.amount;
                    if (t.type === 'expenditure') totalExpenditure += t.amount;
                });
                
                // Fetch direct expenditures
                const expendituresSnapshot = await db.collection('expenditures').get();
                expendituresSnapshot.forEach(doc => {
                    totalExpenditure += doc.data().amount;
                });


                document.getElementById('total-income').textContent = `₹${totalIncome.toFixed(2)}`;
                document.getElementById('total-commission').textContent = `₹${totalCommission.toFixed(2)}`;
                document.getElementById('total-expenditure').textContent = `₹${totalExpenditure.toFixed(2)}`;
                
                document.getElementById('dashboard-loader').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (error) {
                console.error("Error loading dashboard data:", error);
                document.getElementById('dashboard-loader').textContent = "Failed to load dashboard data.";
            }
        }
        
        // ========================================================================
        // --- 9. PDF GENERATION & PRINTING ---
        // ========================================================================
        async function generateAndDownloadPDF(billId) {
            const { jsPDF } = window.jspdf;
            const loader = document.createElement('div');
            loader.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="spinner h-12 w-12 rounded-full border-4 border-t-blue-500"></div></div>`;
            document.body.appendChild(loader);

            try {
                const billDoc = await db.collection('bills').doc(billId).get();
                if (!billDoc.exists) throw new Error("Bill not found");
                
                const bill = billDoc.data();
                const previewEl = document.getElementById('pdf-preview');

                const itemsHtml = bill.items.map((item, index) => `
                    <tr>
                        <td class="py-1">${index + 1}</td>
                        <td>${item.name}</td>
                        <td class="text-right">${item.quantity}</td>
                        <td class="text-right">₹${item.price.toFixed(2)}</td>
                        <td class="text-right">₹${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>`).join('');
                
                const doctorSnap = bill.referredById ? await db.collection('doctors').doc(bill.referredById).get() : null;
                const doctorName = doctorSnap && doctorSnap.exists ? doctorSnap.data().name : 'N/A';

                previewEl.innerHTML = `
                    <div style="border: 1px solid #ccc; padding: 20px;">
                        <div style="text-align: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px;">
                            <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Perfect Diagnostic and Ultrasound Centre</h1>
                            <p style="margin: 5px 0;">Near Government Hospital, Partawal Bazar, Maharajganj</p>
                        </div>
                        <h2 style="text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 20px;">INVOICE</h2>
                        <table style="width: 100%; margin-bottom: 20px; font-size: 14px;">
                            <tr>
                                <td style="width: 50%;"><strong>Patient:</strong> ${bill.patientDetails.name}</td>
                                <td style="width: 50%;"><strong>Bill No:</strong> ${bill.billNumber}</td>
                            </tr>
                            <tr>
                                <td><strong>Age/Sex:</strong> ${bill.patientDetails.age || 'N/A'} / ${bill.patientDetails.gender}</td>
                                <td><strong>Date:</strong> ${bill.createdAt.toDate().toLocaleDateString()}</td>
                            </tr>
                             <tr>
                                <td><strong>Referred by:</strong> Dr. ${doctorName}</td>
                                <td></td>
                            </tr>
                        </table>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead style="background-color: #f2f2f2;">
                                <tr>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">S.No</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Test Name</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Qty</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Rate</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>
                        <div style="margin-top: 20px; text-align: right; font-size: 14px; width: 40%; margin-left: 60%;">
                             <table style="width: 100%;">
                                <tr><td>Subtotal:</td><td style="text-align: right;">₹${bill.subtotal.toFixed(2)}</td></tr>
                                <tr><td>Discount (${bill.discountPercent}%):</td><td style="text-align: right;">- ₹${(bill.subtotal * bill.discountPercent/100).toFixed(2)}</td></tr>
                                <tr><td>GST (${bill.gstPercent}%):</td><td style="text-align: right;">+ ₹${((bill.subtotal - (bill.subtotal * bill.discountPercent/100)) * bill.gstPercent/100).toFixed(2)}</td></tr>
                                <tr style="font-weight: bold; border-top: 1px solid #ccc; padding-top: 5px;"><td>Grand Total:</td><td style="text-align: right;">₹${bill.total.toFixed(2)}</td></tr>
                             </table>
                        </div>
                        <div style="position: absolute; bottom: 20px; right: 20px; font-size: 14px;"><strong>Authorized Signatory</strong></div>
                    </div>
                `;

                const canvas = await html2canvas(previewEl, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`${bill.billNumber}.pdf`);

            } catch (error) {
                console.error("PDF Generation Error:", error);
                alert("Failed to generate PDF: " + error.message);
            } finally {
                document.body.removeChild(loader);
            }
        }
        
        // --- Initial Render ---
        renderApp();
    };
    </script>
</body>
</html>